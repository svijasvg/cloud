[logo]: http://files.svija.love/github/readme-logo.png "Svija: SVG-based websites built in Adobe Illustrator"

*Updated 14 December, 2022 · dev.svija.love*

![Svija: SVG-based websites built in Adobe Illustrator][logo]

### How Pages Work

This document describes how pages "work" — how javascript is used to choose the right screen code, and then adapt the SVG image to the page.

Scripts are loaded in the following order:

1. system JS · sets variables for sitewide settings and this particular page
2. cookies.js · setCookie(), getCookie() and cookiesEnabled()
3. screens.js · redirect if a different screen code would fit the screen better
4. window_mgmt.js · sets rem size based on window size, taking into account if page has been reloaded while zoomed    
includes previous resize.js · adapts content to window when it's resized, but not when it's zoomed
6. sections.js · was meant for use with languages — if visitor was in a certain language, would send them back there if they come back to the site
6. tap_hightlight.js · one line that prevents touch highlights on mobile

These scripts are followed by:

- generic css
- font css
- SVG dimension css (**check this**)
- google analytics js
- GSAP js

Then, in the body:

- unsupported.html · shows messages if javascript or cookies are disabled, or IE
- initial_scroll div & .js · sets a div the size of the first SVG so the page won't scroll as it loads (from when pages were wider than window)
- window_mgmt.js · re-sets rem size based on window size, to correct for the addition of scrollbars
- accessibility · div generated by system containing hidden accessibility HTML
- CSRF token · necessary for form submission 
- SVG's and included scripts
- scripts & HTML included via pages or modules
- page_background.js · matches the page background to the first SVG element for the Safari header
- final JS · delete initial_scroll div & set page_loaded to true

---
### window_mgmt.js notes

causes flash because we don't have correct zoomed width when executed in header

included once in header to get rough overall size then once after initial scroll div to correct for scrollbars — window width changes with the addition of scrollbars, which are only added when the content is loaded.

we don't handle pinch-to-zoom because Safari handles it automatically when page is reloaded.

---
### window_mgmt.js functioning

This script is called twice:
1. in the head, to set the REM size
2. again in the body, to correct the REM size if scrollbars have been added

It also contains listener code to adapt the REM size when the window is resized.

#### Saved Variables

**savedScreen** · resolution of entire screen · we keep the initial value in a cookie. If it changes, we can use the saved value to caluclate the zoom in Firefox. Otherwise, unneeded.

**savedWidth** · width

---
### Main Window Management

**1. store real screen height & width**

These are used later to check if Firefox has been zoomed and if the iPhone has been rotated.

**2. initialize environmental variables**

We need to know at any given time:
- last measured width
- last measured zoom
- whether the page was already zoomed when it was loaded

**NOTE:** if the zoom level at load is near 1 but not 1, it is because of the presence of scrollbars on PC. Therefore, we use **areDifferent()** to see if the zoom is different *enough* to count as a real zoom.

**3. set the REM value**

The rem value is contained in **aiPixel**, which is assigned a value based on the relative width of the window and the zoom level of the page.

**4. add window resize listener**

The function **resize()** will be called whenever a resize event is triggered (see below).

**5. set scroll position**

This is necessary to make centered over-width pages appear centered on load instead of being initially scrolled to the left.

Page offsets are set in admin in **Screen** settings.

The scroll function is called immediately then again after one second

---
### Resize Listener

This is by far the most complex part of the window-management code.

It's necessary that when a window is zoomed or resized, the contents behaves as expected.

However, since the content is scaled to fit the window, the calculation changes every time the window is modified:

- zoomed
- made wider or taller or both
- phone is rotated

In addition, zoom should behave as expected — the Svija code shouldn't override the zoom.

Finally, if the user zooms then reloads the page, the zoom should be persistant.

All of this is handled by function **resize()**.

#### function resize()

**1. exit if we don't need to do anything**

- if page is not fully loaded, do nothing
- if page is made longer but not wider, do nothing

**2. if it's not an iPhone rotation to landscape**

If it's not an iPhone rotating to landscape, we use the zoom to calculate the new value.

To check for this, we see if the new screen width is the same as the real screen height we measured at load. If it is, we know that we have an iPhone that was rotated to landscape.

**3. update the aiPixel value & environmental width variables 

---
### Functions used by the Resize Listener

There are two functions called by resize() that were difficult to implement:

**1. zoomedWidth()**

This returns the current page width **as seen by the page**. It is necessary because the document object can't be meaured by a script running the the `<head>`.

**NOTE:** browsers handle zoom by fooling the page to think that it is in fact smaller — for example a window that starts out at 1200px wide will only have 1000px when it is zoomed 20%.

**2. zoom()**

First we detect if an Android phone was rotated. If the new screen height and width are reversed from what we measured, this is the case and we correct the environmental variables

Then we get a zoom number for all browsers except Firefox by comparing the zoomed (zoomedWidth()) value with the real unzoomed value.

For Firefox, we compare the new (false) screen size with the real screen size that we measured at load and stored in a cookie.

Finally, if the zoom level approaches 1, we return 1 because it's PC scrollbars that are throwing if off. If we took into account the slight difference, the page would be ever-so-slightly too wide.

**3. globalThisOuterWidth()**

This function replaces the globalThis.outerWidth value.

We do this because iPhones lie about this value, and this function corrects the value.

---
<details><summary>ways to measure width</summary>

```
document.body.clientWidth
document.body.scrollWidth
document.documentElement.scrollWidth
globalThis.innerWidth
globalThis.outerWidth
globalThis.screen.availWidth 
screen.availWidth
screen.width
window.innerWidth
window.outerWidth
window.screen.availWidth
window.screen.width
```
```
Screen {
    availWidth: 1920,
    availHeight: 1040,
    width: 1920,
    height: 1080,
    colorDepth: 24,
    pixelDepth: 24,
    top: 414,
    left: 1920,
    availTop: 414,
    availLeft: 1920
```

there are basicalyy tow cases:

firefox and not firefox

for firefox, we compare current screen size to the first measured size
for others, we...

```
//                                                              |——————————— MAC —————————————|  |——————— PC ——————|
//                                                              s100 s125  f100 f120  c100 c125  f100 f150 c100 c125
console.log('aa'+document.documentElement.clientWidth);      // 
console.log('ab'+document.documentElement.scrollWidth);      // 1758 1407  1771 1476  1920 1536   914  731 1148  918
console.log('ac'+globalThis.innerWidth);                     // 1758 1406  1771 1476  1920 1536   914  731 1148  918
console.log('ad'+window.innerWidth);                         // 1758 1406  1771 1476  1920 1536   914  731 1148  918

console.log('ba'+globalThis.outerWidth);                     // 1758 1758  1771 1476  1920 1920   923  739 1161 1161
console.log('ba'+window.outerWidth);                         // 1758 1758  1771 1476  1920 1920   923  739 1161 1161

console.log('ca'+globalThis.screen.availWidth );             // 2560 2560  2560 2133  2560 2560  1200  960 1440 1440
console.log('cb'+screen.availWidth);                         // 2560 2560  2560 2133  2560 2560  1200  960 1440 1440
console.log('cc'+screen.width);                              // 256O 2560  2560 2133  2560 2560  1200  960 1440 1440
console.log('cd'+window.screen.availWidth);                  // 2560 2560  2560 2133  2560 2560  1200  960 1440 1440
console.log('ce'+window.screen.width);                       // 2560 2560  2560 2133  2560 2560  1200  960 1440 1440
```


I don't even need to know the exact zoom amount, I just need to know if it was a zoom or resize

if it's a zoom of less than 10%, it was a resize

ALL OF THIS IS THE RESIZE HANDLER

```
// iPhone, ON LOAD
console.log('aa'+document.documentElement.clientWidth);      //  390
console.log('ab'+document.documentElement.scrollWidth);      //  390
console.log('ac'+globalThis.innerWidth);                     //  390
console.log('ad'+window.innerWidth);                         //  390

console.log('ba'+globalThis.outerWidth);                     //  390
console.log('ba'+window.outerWidth);                         //  390

console.log('ca'+globalThis.screen.availWidth );             //  390
console.log('cb'+screen.availWidth);                         //  390
console.log('cc'+screen.width);                              //  390
console.log('cd'+window.screen.availWidth);                  //  390
console.log('ce'+window.screen.width);                       // 



console.log('aa'+document.documentElement.clientHeight);      //  664
console.log('ab'+document.documentElement.scrollHeight);      // 2769
console.log('ac'+globalThis.innerHeight);                     //  664
console.log('ad'+window.innerHeight);                         //  664

console.log('ba'+globalThis.outerHeight);                     //  844
console.log('ba'+window.outerHeight);                         //  844

console.log('ca'+globalThis.screen.availHeight );             //  844
console.log('cb'+screen.availHeight);                         //  844
console.log('cc'+screen.height);                              //  844
console.log('cd'+window.screen.availHeight);                  //  844
console.log('ce'+window.screen.height);                       // 


ON ROTATE
                                                         // to land  port
console.log('aa'+document.documentElement.clientWidth);      // 844  390
console.log('ab'+document.documentElement.scrollWidth);      // 844  390
console.log('ac'+globalThis.innerWidth);                     // 844  390
console.log('ad'+window.innerWidth);                         // 844  390

console.log('ba'+globalThis.outerWidth);                     // 390  844
console.log('ba'+window.outerWidth);                         // 390  844

console.log('ca'+globalThis.screen.availWidth );             // 390  390
console.log('cb'+screen.availWidth);                         // 390  390
console.log('cc'+screen.width);                              // 390  390
console.log('cd'+window.screen.availWidth);                  // 390  390
console.log('ce'+window.screen.width);                       // 390  390



console.log('aa'+document.documentElement.clientHeight);      //  664
console.log('ab'+document.documentElement.scrollHeight);      // 6836
console.log('ac'+globalThis.innerHeight);                     //  664
console.log('ad'+window.innerHeight);                         //  664

console.log('ba'+globalThis.outerHeight);                     //  390
console.log('ba'+window.outerHeight);                         //  390 

console.log('ca'+globalThis.screen.availHeight );             //  844
console.log('cb'+screen.availHeight);                         //  844
console.log('cc'+screen.height);                              //  844
console.log('cd'+window.screen.availHeight);                  //  844
console.log('ce'+window.screen.height);                       //  844
```

There are two issues affecting mobile screens, when turned into landscape mode:
- Android changes the listed screen size (which we were storing for comparison, so needs to be updated)
- iPhone DOESN'T change the listed screen, so the new page is superficially much wider than the screen

</details>
